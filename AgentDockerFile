# builder будет использоваться для создания исполняемого файла сервера
FROM golang:alpine AS builder

# WORKDIR - рабочая директория в контейнере
WORKDIR /wd  

# dependicies
# ./ - путь в контейнере
COPY go.mod go.sum ./
# явно грузим зависимости
RUN go mod download

# копируем server code в контейнер в /wd
COPY internal internal 
COPY cmd/agent/*.go cmd/agent/

# меняем рабочую директорию на папку с кодом сервера 
WORKDIR /wd/cmd/agent
# создаём исполняемый файл agentura в /wd/cmd/server
RUN go build -o agentura

# грузим чистый образ, в нём будет только исполняемый файл сервера
FROM alpine AS runner  

# копируем сбилденный /wd/cmd/agent/agentura в корень / runner
COPY --from=builder /wd/cmd/agent/agentura / 

# открываем порт 
# такой же как на сервере, в http.ListenAndServe
EXPOSE 8080 

# запускаем исполняемый файл servak
CMD ["./agentura"] 

# и проверяем в консоли
# curl localhost:8000
